---
###############################################################################
#
# DHCPv4 CONFIGURATION
#
###############################################################################

server4:
  plugins:
    ############################################################################
    #
    # NORMAL COREDHCP PLUGIN CONFIGURATION
    #
    ############################################################################

    # REQUIRED: server_id configures the identity/IP of the DHCP server. This
    # is necessary to distinguish it from possible other DHCP servers on the
    # network.
    - server_id: 172.16.0.253

    # OPTIONAL: dns provides a list of DNS servers to use for names.
    - dns: 1.1.1.1 8.8.8.8

    # REQUIRED: router specifies the IP of the gateway of the network. This can
    # be the same as server_id if the router is at the same IP.
    - router: 172.16.0.254

    # REQUIRED: netmask specifies the network mask to be used with IP addresses
    # served by DHCP.
    - netmask: 255.255.255.0

    ############################################################################
    #
    # CORESMD CONFIGURATION
    #
    ############################################################################

    # REQUIRED: coresmd communicates with SMD and tries to match any MAC it
    # receives to EthernetInterfaces in SMD. If one if found, the corresponding
    # IP is leased to the requesting machine and packet processing terminates
    # here. Otherwise, the packet processing continues to any plugins after
    # this.
    #
    # The format of configuration options below is "key=value", with no spaces
    # on either side of the equal sign. Quotes around values are optional.
    #
    # CUSTOM HOSTNAMES
    #
    # For node_pattern and bmc_pattern (see CONFIGURATION KEYS below), custom
    # hostname patterns can be specified to dynamically generate custom
    # hostnames for BMCs and nodes in SMD.
    #
    # Hostname Placeholder Syntax:
    #
    #   {Nd} - Zero-padded NID where N is the number of digits
    #          Examples: {04d} -> 0001, 0042, 1234
    #                    {02d} -> 01, 42, 99
    #                    {05d} -> 00001, 00042, 12345
    #   {id} - Component xname (e.g., x3000c0s0b0n0 for nodes, x3000c0s0b1 for
    #          BMCs)
    #
    # Literal text can be mixed with placeholders:
    #
    #   "compute-{04d}" -> compute-0001, compute-0042
    #   "node-{id}"     -> node-x3000c0s0b0n0
    #   "dev-s{02d}"    -> dev-s01, dev-s42
    #
    # CUSTOM DOMAINS:
    #
    # If 'domain' is specified (see CONFIGURATION KEYS below), a custom domain
    # will be appended to hostnames generated using the custom hostname
    # mechanism above, making generated hostnames fully-qualified.
    #
    # For instance, for the following configuration:
    #
    #   - coresmd: ... node_pattern="{id}" bmc_pattern="{id}" domain=cluster.local
    #
    # {id} will be expanded to the node/BMC's xname and the domain cluster.local
    # will be appended. For example:
    #
    #   BMC hostname:  x3000c0s0b1.cluster.local
    #   Node hostname: x3000c0s0b1n0.cluster.local
    #
    # CONFIGURATION KEYS
    #
    # svc_base_uri (REQUIRED, string)
    #   The base URI used to communicate with SMD. The SMD API
    #   paths are appended to this.
    #
    # ipxe_base_uri (REQUIRED, string)
    #   The base URI used to retrieve boot scripts. This is usually a base HTTP
    #   URL to BSS, since the iPXE bootloader served by CoreSMD doesn't include
    #   an OpenCHAMI CA certificate by default to do proper TLS. It may also be
    #   an IP address if name servers are nod configured.
    #
    # ca_cert (OPTIONAL, string)
    #   The path to a certificate authority certificate used for TLS
    #   verification when contacting SMD. This config option can be omitted if
    #   not using HTTPS or there is already a trusted certificate in the
    #   system's certificate bundle.
    #
    # cache_valid (OPTIONAL, string, default=30s)
    #   The duration of time the SMD cache is valid. If omitted, the default
    #   value will be used.
    #
    #   The format of a time duration is a sequence of decimal numbers with an
    #   optional fraction and a unit suffix, such as "300ms"  or "2h45m". Valid
    #   time units are "ns", "us" (or "µs"), "ms", "s", "m", "h".
    #
    # lease_time (OPTIONAL, string, default=1h)
    #   The time duration that the served leases are valid. If omitted, the
    #   default value will be used.
    #
    #   The format of a time duration is a sequence of decimal numbers with an
    #   optional fraction and a unit suffix, such as "300ms"  or "2h45m". Valid
    #   time units are "ns", "us" (or "µs"), "ms", "s", "m", "h".
    #
    # single_port (OPTIONAL, boolean, default=false)
    #   A boolean option that determines whether CoreSMD should use single port
    #   mode for TFTP. In this mode, the TFTP server will use tftp_port for all
    #   communication instead of using random high ports. This mode can be
    #   helpful for restrictive firewall environments or NAT configurations.
    #
    # tftp_dir (OPTIONAL, string, default=/tftpboot)
    #   The filesystem path to the TFTP server root directory. If omitted, the
    #   default value will be used.
    #
    # tftp_port (OPTIONAL, integer, default=69)
    #   The transport layer network port to bind to. If omitted, the default
    #   value will be used.
    #
    # node_pattern (OPTIONAL, string, default=id{04d})
    #   The hostname pattern to use to generate hostnames for nodes in SMD. See
    #   CUSTOM HOSTNAMES above for details.
    #
    # bmc_pattern (OPTIONAL, string, default=bmc{04d})
    #   The hostname pattern to use to generate hostnames for BMCs in SMD. See
    #   CUSTOM HOSTNAMES above for details.
    #
    # domain (OPTIONAL, string)
    #   An optional domain to append to hostnames generated with node_pattern
    #   and bmc_pattern. If omitted, no domain will be appended. See CUSTOM
    #   DOMAINS above for details.
    - coresmd: |
        svc_base_uri=https://foobar.openchami.cluster
        ipxe_base_uri=http://172.16.0.253:8081
        ca_cert=/root_ca/root_ca.crt
        cache_valid=30s
        lease_time=1h
        single_port=false
        tftp_dir=/tftpboot
        tftp_port=69
        node_pattern=nid{04d}
        bmc_pattern=bmc{04d}
        domain=openchami.cluster

    # Any requests reaching this point are unknown to SMD and it is up to the
    # administrator to decide how to handle unknown packets.

    # OPTIONAL: If the administrator cares about which IP addresses are
    # assigned to which MAC addresses (e.g. the hosts file matches names to BMC
    # IPs), CoreDHCP provides the file plugin for this purpose.
    #
    # The administrator will want to set lease_time to how long caught-all IP
    # addresses should last. This could be long or short depending on the need.
    - lease_time: 10m
    #
    # The file reads a file on the filesystem that maps MAC addresses to IP
    # addresses. Its format is similar to a hosts file, e.g:
    #
    #   <mac_addr1> <ip_addr1>
    #   <mac_addr2> <ip_addr2>
    #   ...
    #
    - file: /etc/coredhcp/hostsfile

    # OPTIONAL: If the administrator does not care about which IP addresses are
    # assigned to which MAC addresses (or wants a catch-all after mapping
    # relevant IPs to MACs using the file plugin above), coresmd provides the
    # bootloop plugin.
    #
    # This plugin serves temporary IP addresses defined by a range with the
    # given leas time, which should be short. Once the IP expires and the
    # machine tries to renew its lease, a DHCPNAK is sent to make the device
    # send a DHCPDISCOVER to re-perform the entire DHCP handshake. An iPXE boot
    # script that reboots is served to all devices requesting an IP so that
    # devices that can reboot will do so (to force it to redo the entire DHCP
    # handshake).
    #
    # The format of configuration options below is "key=value", with no spaces
    # on either side of the equal sign. Quotes around values are optional.
    #
    # CONFIGURATION KEYS
    #
    # lease_file (REQUIRED, string)
    #   The filesystem path to a file to store the mac-IP mappings for the
    #   leases in. The file is not expected to exist, though it will be
    #   overwritten if so. The format of the file is an Sqlite database.
    #
    # script_path (OPTIONAL, string, default=default)
    #   The filesystem path to an PXE script to serve to DHCP requests. If
    #   using the build-in coresmd FTP server, this should be 'default', which
    #   will make bootloop serve a simple iPXE script that reboots.
    #
    #   This doesn't need to be changed unless non-default boot script behavior
    #   is desired.
    #
    # lease_time (OPTIONAL, string, default=5m)
    #   The time duration that served leases are valid. If omitted, the default
    #   value will be used.
    #
    #   The format of a time duration is a sequence of decimal numbers with an
    #   optional fraction and a unit suffix, such as "300ms"  or "2h45m". Valid
    #   time units are "ns", "us" (or "µs"), "ms", "s", "m", "h".
    #
    # ipv4_start (REQUIRED, string)
    #   The start IPv4 address for the pool of IPs to assign.
    #
    # ipv4_end (REQUIRED, string)
    #   The end IPv4 address for the pool of IPs to assign.
    - bootloop: |
        lease_file=/tmp/coredhcp.db
        script_path=default
        lease_time=5m
        ipv4_start=172.16.0.156
        ipv4_end=172.16.0.200

###############################################################################
#
# DHCPv6 CONFIGURATION
#
###############################################################################

server6:
  # Listen on all IPv6-capable interfaces. Alternatively, specify a particular
  # IPv6 address or interface name.
  listen:
    - "[::]"

  plugins:
    ############################################################################
    #
    # NORMAL COREDHCP DHCPv6 PLUGIN CONFIGURATION
    #
    ############################################################################

    # REQUIRED: server_id configures the identity of the DHCPv6 server using
    # a DUID (DHCP Unique Identifier). Common formats:
    #   - LL (Link-Layer): Uses MAC address, e.g., "LL 00:de:ad:be:ef:00"
    #   - LLT (Link-Layer + Time): Includes timestamp
    #   - EN (Enterprise Number): For organization-specific identifiers
    - server_id: LL 00:de:ad:be:ef:00

    # OPTIONAL: dns provides a list of IPv6 DNS servers to use for name
    # resolution. These should be valid IPv6 addresses.
    - dns: fd00:100::254 2001:4860:4860::8888

    ############################################################################
    #
    # CORESMD DHCPv6 CONFIGURATION
    #
    ############################################################################

    # REQUIRED: coresmd communicates with SMD and tries to match any MAC it
    # receives to EthernetInterfaces in SMD. If one is found, the corresponding
    # IPv6 address is leased to the requesting machine and packet processing
    # terminates here.
    #
    # The configuration format and options are identical to DHCPv4 (see above).
    # The key difference is that DHCPv6 will automatically select IPv6 addresses
    # from the IPAddresses field in SMD's EthernetInterfaces.
    #
    # DHCPv6-SPECIFIC NOTES:
    #
    # - IPv6 addresses must be present in SMD for the EthernetInterfaces
    # - FQDN options (via domain= configuration) work with DHCPv6
    # - Boot file URLs should use IPv6 addresses in bracket notation:
    #   tftp://[fd00:100::254]:69/ipxe.efi
    # - The ipxe_base_uri should include IPv6 addresses in bracket notation if
    #   using IP addresses directly: http://[fd00:100::254]:8081
    #
    # All configuration keys from DHCPv4 apply:
    # - svc_base_uri, ipxe_base_uri, ca_cert
    # - cache_valid, lease_time
    # - single_port, tftp_dir, tftp_port
    # - node_pattern, bmc_pattern, domain
    - coresmd: |
        svc_base_uri=https://foobar.openchami.cluster
        ipxe_base_uri=http://[fd00:100::254]:8081
        ca_cert=/root_ca/root_ca.crt
        cache_valid=30s
        lease_time=1h
        single_port=false
        tftp_dir=/tftpboot
        tftp_port=69
        node_pattern=nid{04d}
        bmc_pattern=bmc{04d}
        domain=openchami.cluster

    # NOTE: The bootloop plugin currently only supports DHCPv4 and is not
    # available for DHCPv6. For DHCPv6, consider using other mechanisms for
    # handling unknown devices or rely on SMD having complete inventory.
